FROM rust:1-alpine3.18

ARG UID=1000
ARG GID=1000
RUN addgroup -g $GID indy && adduser -u $UID -D -G indy indy

RUN apk update && apk upgrade && apk add --no-cache \
       build-base \
       curl \
       openssl-dev \
       zeromq-dev

USER indy
WORKDIR /home/indy

ARG RUST_VER="1.77.0"
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain $RUST_VER --default-host x86_64-unknown-linux-musl
ENV PATH="/home/indy/.cargo/bin:$PATH"

RUN cargo new --bin aries-vcx-backchannel
WORKDIR ./aries-vcx-backchannel
COPY --chown=indy:indy ./aries-vcx/Cargo.lock ./aries-vcx/Cargo.toml ./
ENV CARGO_NET_GIT_FETCH_WITH_CLI=true
RUN cargo build

#ENTRYPOINT ["cargo", "run"]